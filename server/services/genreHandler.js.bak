// Handle simple genre queries without calling Claude to avoid rate limiting
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';
import { parse } from 'csv-parse/sync';

const __dirname = path.dirname(fileURLToPath(import.meta.url));

// Load genre taxonomy
const genreTaxonomy = (() => {
  const csvPath = path.join(__dirname, '..', '..', 'data', 'genre_taxonomy.csv');
  const content = fs.readFileSync(csvPath, 'utf-8');
  return parse(content, { columns: true });
})();

// Genre disambiguation responses for common broad genres
const GENRE_DISAMBIGUATIONS = {
  'rock': {
    message: "Rock covers a lot of ground. What style are you after?",
    subgenres: [
      { name: "Rock", id: "1322", count: 299 },
      { name: "Hard Rock / Metal", id: "1339", count: 215 },
      { name: "Alternative", id: "1323", count: 60 },
      { name: "Modern Rock", id: "1338", count: 56 },
      { name: "Metal", id: "1336", count: 53 },
      { name: "Blues / Rock", id: "1103", count: 47 },
      { name: "Garage Rock", id: "1327", count: 32 },
      { name: "Southern Rock", id: "1357", count: 26 },
      { name: "Surf", id: "1358", count: 17 }
    ]
  },
  'classical': {
    message: "Classical is pretty broad - are you thinking famous composers, modern neo-classical, or something else?",
    subgenres: [
      { name: "Well-known classical pieces", description: "Mozart, Beethoven, Bach" },
      { name: "Modern/neo-classical compositions" },
      { name: "Classical styling", description: "Contemporary tracks with classical elements" },
      { name: "Baroque Era" },
      { name: "Romantic Era" },
      { name: "20th Century Classical" }
    ]
  },
  'jazz': {
    message: "What kind of jazz are you looking for?",
    subgenres: [
      { name: "Jazz", id: "1216", count: 206 },
      { name: "Big Band / Swing", id: "1201", count: 45 },
      { name: "Smooth Jazz", id: "1224", count: 42 },
      { name: "Bebop", id: "1218", count: 33 },
      { name: "Jazz Fusion", id: "1219", count: 29 },
      { name: "Latin Jazz", id: "1222", count: 24 }
    ]
  }
};

export function isSimpleGenreQuery(message) {
  const query = message.toLowerCase().trim();
  return GENRE_DISAMBIGUATIONS.hasOwnProperty(query);
}

export function handleGenreDisambiguation(genre) {
  const disambiguation = GENRE_DISAMBIGUATIONS[genre.toLowerCase()];
  if (!disambiguation) return null;

  // Format the response as markdown
  let response = `${disambiguation.message}\n\n`;

  for (const subgenre of disambiguation.subgenres) {
    response += `- **${subgenre.name}**`;
    if (subgenre.count) {
      response += ` (${subgenre.count} tracks)`;
    }
    if (subgenre.description) {
      response += ` - ${subgenre.description}`;
    }
    response += '\n';
  }

  return response;
}

// Check if a message is a disambiguation response (user selecting from options)
export function isDisambiguationResponse(messages) {
  if (messages.length < 2) return false;

  // Check if the last assistant message was a disambiguation prompt
  const lastAssistantMessage = [...messages].reverse().find(m => m.role === 'assistant');
  if (!lastAssistantMessage) return false;

  const content = lastAssistantMessage.content.toLowerCase();
  return content.includes('what style') ||
         content.includes('what kind') ||
         content.includes('which flavor') ||
         content.includes('what direction');
}