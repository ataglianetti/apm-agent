
// $( document ).ready(function() {
	  

// // 	var data = JSON.parse('{\"match\":true,\"value\":7.756951,\"description\":\"sum of:\",\"details\":[{\"match\":true,\"value\":7.260705,\"description\":\"max plus 0.01 times others of:\",\"details\":[{\"match\":true,\"value\":7.184535,\"description\":\"weight(combined_genre_flat:rock in 45997) [], result of:\",\"details\":[{\"match\":true,\"value\":7.184535,\"description\":\"score(doc=45997,freq=2.0 = termFreq=2.0\\n), product of:\",\"details\":[{\"match\":true,\"value\":4,\"description\":\"boost\"},{\"match\":true,\"value\":1.7961338,\"description\":\"idf(docFreq=103030, maxDocs=620892)\"},{\"match\":true,\"value\":1,\"description\":\"tfNorm, computed from:\",\"details\":[{\"match\":true,\"value\":2,\"description\":\"termFreq=2.0\"},{\"match\":true,\"value\":0,\"description\":\"parameter k1\"},{\"match\":true,\"value\":0,\"description\":\"parameter b\"},{\"match\":true,\"value\":6.8293357,\"description\":\"avgFieldLength\"},{\"match\":true,\"value\":7.111111,\"description\":\"fieldLength\"}]}]}]},{\"match\":true,\"value\":0.33070552,\"description\":\"weight(album_title_en:rock in 45997) [], result of:\",\"details\":[{\"match\":true,\"value\":0.33070552,\"description\":\"score(doc=45997,freq=1.0 = termFreq=1.0\\n), product of:\",\"details\":[{\"match\":true,\"value\":0.1,\"description\":\"boost\"},{\"match\":true,\"value\":3.3070552,\"description\":\"idf(docFreq=22739, maxDocs=620892)\"},{\"match\":true,\"value\":1,\"description\":\"tfNorm, computed from:\",\"details\":[{\"match\":true,\"value\":1,\"description\":\"termFreq=1.0\"},{\"match\":true,\"value\":1.2,\"description\":\"parameter k1\"},{\"match\":true,\"value\":0,\"description\":\"parameter b\"},{\"match\":true,\"value\":2.8470073,\"description\":\"avgFieldLength\"},{\"match\":true,\"value\":2.56,\"description\":\"fieldLength\"}]}]}]},{\"match\":true,\"value\":6.7607183,\"description\":\"weight(instrumental_and_vocal_groupings_en:rock in 45997) [], result of:\",\"details\":[{\"match\":true,\"value\":6.7607183,\"description\":\"score(doc=45997,freq=1.0), product of:\",\"details\":[{\"match\":true,\"value\":3.2889435,\"description\":\"queryWeight, product of:\",\"details\":[{\"match\":true,\"value\":3.2889435,\"description\":\"idf(docFreq=62941, maxDocs=620892)\"},{\"match\":true,\"value\":1,\"description\":\"queryNorm\"}]},{\"match\":true,\"value\":2.0555897,\"description\":\"fieldWeight in 45997, product of:\",\"details\":[{\"match\":true,\"value\":1,\"description\":\"tf(freq=1.0), with freq of:\",\"details\":[{\"match\":true,\"value\":1,\"description\":\"termFreq=1.0\"}]},{\"match\":true,\"value\":3.2889435,\"description\":\"idf(docFreq=62941, maxDocs=620892)\"},{\"match\":true,\"value\":0.625,\"description\":\"fieldNorm(doc=45997)\"}]}]}]},{\"match\":true,\"value\":0.11198694,\"description\":\"weight(track_description_en:rock in 45997) [], result of:\",\"details\":[{\"match\":true,\"value\":0.11198694,\"description\":\"score(doc=45997,freq=2.0), product of:\",\"details\":[{\"match\":true,\"value\":0.07118954,\"description\":\"queryWeight, product of:\",\"details\":[{\"match\":true,\"value\":0.02,\"description\":\"boost\"},{\"match\":true,\"value\":3.559477,\"description\":\"idf(docFreq=48022, maxDocs=620892)\"},{\"match\":true,\"value\":1,\"description\":\"queryNorm\"}]},{\"match\":true,\"value\":1.5730815,\"description\":\"fieldWeight in 45997, product of:\",\"details\":[{\"match\":true,\"value\":1.4142135,\"description\":\"tf(freq=2.0), with freq of:\",\"details\":[{\"match\":true,\"value\":2,\"description\":\"termFreq=2.0\"}]},{\"match\":true,\"value\":3.559477,\"description\":\"idf(docFreq=48022, maxDocs=620892)\"},{\"match\":true,\"value\":0.3125,\"description\":\"fieldNorm(doc=45997)\"}]}]}]},{\"match\":true,\"value\":0.023940302,\"description\":\"weight(album_description_en:rock in 45997) [], result of:\",\"details\":[{\"match\":true,\"value\":0.023940302,\"description\":\"score(doc=45997,freq=1.0), product of:\",\"details\":[{\"match\":true,\"value\":0.033081926,\"description\":\"queryWeight, product of:\",\"details\":[{\"match\":true,\"value\":0.01,\"description\":\"boost\"},{\"match\":true,\"value\":3.3081927,\"description\":\"idf(docFreq=61741, maxDocs=620892)\"},{\"match\":true,\"value\":1,\"description\":\"queryNorm\"}]},{\"match\":true,\"value\":0.72366714,\"description\":\"fieldWeight in 45997, product of:\",\"details\":[{\"match\":true,\"value\":1,\"description\":\"tf(freq=1.0), with freq of:\",\"details\":[{\"match\":true,\"value\":1,\"description\":\"termFreq=1.0\"}]},{\"match\":true,\"value\":3.3081927,\"description\":\"idf(docFreq=61741, maxDocs=620892)\"},{\"match\":true,\"value\":0.21875,\"description\":\"fieldNorm(doc=45997)\"}]}]}]},{\"match\":true,\"value\":0.3896375,\"description\":\"weight(track_title_en:rock in 45997) [], result of:\",\"details\":[{\"match\":true,\"value\":0.3896375,\"description\":\"score(doc=45997,freq=1.0), product of:\",\"details\":[{\"match\":true,\"value\":0.1248419,\"description\":\"queryWeight, product of:\",\"details\":[{\"match\":true,\"value\":0.02,\"description\":\"boost\"},{\"match\":true,\"value\":6.242095,\"description\":\"idf(docFreq=3283, maxDocs=620892)\"},{\"match\":true,\"value\":1,\"description\":\"queryNorm\"}]},{\"match\":true,\"value\":3.1210475,\"description\":\"fieldWeight in 45997, product of:\",\"details\":[{\"match\":true,\"value\":1,\"description\":\"tf(freq=1.0), with freq of:\",\"details\":[{\"match\":true,\"value\":1,\"description\":\"termFreq=1.0\"}]},{\"match\":true,\"value\":6.242095,\"description\":\"idf(docFreq=3283, maxDocs=620892)\"},{\"match\":true,\"value\":0.5,\"description\":\"fieldNorm(doc=45997)\"}]}]}]}]},{\"match\":true,\"value\":0.49624577,\"description\":\"FunctionQuery(div(mod(sum(product(scale(int(song_number),0.0,100000.0),int(track_number)),const(1234)),const(100000)),const(200000))), product of:\",\"details\":[{\"match\":true,\"value\":0.49624577,\"description\":\"div(mod(sum(product(scale(int(song_number)=728833,toMin=0.0,toMax=100000.0,fromMin=200053.0,fromMax=739541.0),int(track_number)=1),const(1234)),const(100000)),const(200000))\"},{\"match\":true,\"value\":1,\"description\":\"boost\"},{\"match\":true,\"value\":1,\"description\":\"queryNorm\"}]}]}');
// // 	$("#explain").replaceWith(formatScore('7.756951',data));
	
// });

function parseSolrQuery() {

	// 2018-05-04 22:33:16.940 INFO  (qtp434176574-21) [   x:tracks] o.a.s.c.S.Request [tracks]  webapp=/solr path=/apm 
	// params={mm=100%25&bf=div(mod(sum(product(scale(song_number,0,100000),track_number),1234),100000),400000)&fl=track_id,track_number,album_description,track_description,akTrack,akcd,duration,track_title,album_title,album_code,bpm,has_lyrics,apm_release_date,lyrics,publisher,track_type,sublibrary_name,sublibrary_code,library_name,library_code,composer,composers_societies,artist_driven,song_number,score,total_versions,relates_to_count_i,track_type,sound_effects,is_a,lyric_subject,time_period,tempo,musical_form,library,key,movement,country_and_region,character,instruments,mood,music_for,additional_genre,vocals,instrumental_and_vocal_groupings,genre,track_type_ids,sound_effects_ids,is_a_ids,lyric_subject_ids,time_period_ids,tempo_ids,musical_form_ids,library_ids,key_ids,movement_ids,country_and_region_ids,character_ids,instruments_ids,mood_ids,music_for_ids,additional_genre_ids,vocals_ids,instrumental_and_vocal_groupings_ids,genre_ids,combined_genre_ids,track_type_children,sound_effects_children,is_a_children,lyric_subject_children,time_period_children,tempo_children,musical_form_children,library_children,key_children,movement_children,country_and_region_children,character_children,instruments_children,mood_children,music_for_children,additional_genre_children,vocals_children,instrumental_and_vocal_groupings_children,genre_children&group.limit=1&start=0&fq=-library_code:CHM&sort=score+desc&rows=25&bq=genre_en:"indie"^0.05&bq=genre_en:"ska"^0.05&q=indie+ska&apmquery=search_tracks&tie=0.01&defType=edismax&group.main=true&group.sort=score+desc,track_number+asc&group.format=grouped&qf=combined_genre_flat_en^4+character_flat_en+mood_flat_en+musical_form_flat_en+instruments_flat_en^0.6+music_for_flat_en^0.75+vocals_flat_en+movement_flat_en^0.6+instrumental_and_vocal_groupings_flat_en^0.01+sound_effects_flat_en^0.25+country_and_region_flat_en+time_period_flat_en+lyric_subject_flat_en^0.1+track_type_flat_en+tempo_flat_en+is_a_flat_en+track_description_flat_en^0.15+track_title_flat_en^0.2+library_flat_en^0.05+album_title_flat_en^0.1+album_description_flat_en^0.01+composer_flat_en^0.1+lyrics_flat_en^0.1&pf2=combined_genre_flat_en^4+character_flat_en+mood_flat_en+musical_form_flat_en+instruments_flat_en^0.6+music_for_flat_en+vocals_flat_en+movement_flat_en^0.6+instrumental_and_vocal_groupings_flat_en^0.01+sound_effects_flat_en^0.5+country_and_region_flat_en+time_period_flat_en+lyric_subject_flat_en^0.1+track_type_flat_en+tempo_flat_en+is_a_flat_en+track_description_flat_en^0.2+track_title_flat_en^0.5+library_flat_en^0.1+album_title_flat_en^0.15+album_description_flat_en^0.10+composer_flat_en^0.5+lyrics_flat_en^0.5&wt=xml&group.field=song_number&group=true
	// } hits=915 status=0 QTime=56

	var logValue = $("#logEntry").val();
	var query = logValue.replace(/.*\{(.*)\}.*/, "$1");
	var params = query.split("&");
	for (var i = 0, iLen = params.length; i < iLen; i++) {
		var param = params[i].split("=");
		var key = param[0];
		var val = param[1];
		if (key === "q") {
			val = val.replace(/\+/g, " ");
			$("#q").val(val);
		}
		if (key === "tie") {
			$("#config_tie").val(val);
		}
		if (key === "qf") {
			val = val.replace(/\+/g, " ");
			$("#config_qf").val(val);
		}
		if (key === "pf2") {
			val = val.replace(/\+/g, " ");
			$("#config_pf2").val(val);
		}
		if (key === "bq") {
			val = val.replace(/"/g, "%22");
			var anchor = $("#config_bq_anchor");
			anchor.append("bq: ");
			var bq = $("input");
			bq.attr("name", "bq");
			bq.attr("value", decodeURIComponent(val));
			anchor.append(bq);
			$("#config_default_bq").remove();
			anchor.show();
		}
		if (key === "bf") {
			$("#config_bf").val(val);
		}		
	}
	$("#logEntry").val("");
}

function showFormat(obj) {

	var scoreData = obj.siblings("pre").text()
	var explainDiv = obj.siblings("#explain");
	var explainData = explainDiv.find("#explain_data");

	if (explainDiv.is(":hidden")) {

		var scoreData = scoreData.trim();
		console.log(scoreData);

		if (scoreData.endsWith(")")) {
			scoreData = scoreData.slice(0, -1);
		}

		scoreData = scoreData.replace(/\n|\r/g,"");
		scoreData = scoreData.replace(/description=((.|\n)+?)(,details|\})/g, '"description":"$1"$3');
		scoreData = scoreData.replace(/(match|value|details)=/g, '"$1":');

		console.log(scoreData);
		var renderedData = formatScore('1', JSON.parse(scoreData));
		explainData.replaceWith(renderedData);
		explainDiv.toggle();
	} else {
		explainDiv.toggle();
	}

	

}

function formatScore(score, debugscore){
	var scoreJson = renderExplain(debugscore);
	var sQstr = '<div class="graph">'; 

	sQstr += '<div class="score-wrapper">';
	sQstr += '<div class="score-term">Score Totals</div>';
	sQstr += '<div class="score-field font80">Total Score = ' + scoreJson.total + '</div>';	
	sQstr += '<div class="score-field font80">Contributed by Fields = ' + scoreJson.totalContributedFieldScore + '</div>';	
	sQstr += '<div class="score-field font80">Contributed by Boosts = ' + scoreJson.boost.contributedScore + '</div>';	
	sQstr += '<div class="score-field font80">Additional Tiebreaker = ' + scoreJson.tie + '</div>';	
	sQstr += '</div>';	

	if(scoreJson.byFieldTerm !== undefined && scoreJson.byFieldTerm.length > 0) {
		sQstr += buildScoreGraph(scoreJson.byFieldTerm, "Field & Term Contributions"); 
	}

	if(scoreJson.byField !== undefined && scoreJson.byField.length > 0) {
		sQstr += buildScoreGraph(scoreJson.byField, "Field Contributions"); 
	}

	if(scoreJson.byPhrase !== undefined && scoreJson.byPhrase.length > 0) {
		sQstr += buildScoreGraph(scoreJson.byPhrase, "Phrase Contributions"); 
	}

	if(scoreJson.byTerm !== undefined && scoreJson.byTerm.length > 0) {
		sQstr += buildScoreGraph(scoreJson.byTerm, "Term Contributions"); 
	}

	if(scoreJson.boost !== undefined && scoreJson.boost.type == "boost" ) {
		sQstr += buildBoostGraph(scoreJson.boost, "Boost Formula Contribution", scoreJson.total); 
	}

	if(scoreJson.boost !== undefined && scoreJson.boost.type == "bf" ) {
		sQstr += buildBoostGraph(scoreJson.boost, "Boost Formula Contribution", scoreJson.total); 
	}	



	sQstr += '</div>'; 
	sQstr += '<div><a href="#" onclick="jQuery(this).siblings(\'pre\').toggle(); return false;">Show Raw Explain Data</a>';
	sQstr += '<pre class="score-field font80" style="display:none;">' + JSON.stringify( debugscore, undefined, 2 ) + '</pre></div>'; 
	// + JSON.stringify( debugscore.details )
	str = '<span>' + sQstr + '</span>';
	return str;
}

function renderExplain(jsonExplainData) {
	var analysis = new ExplainParser(jsonExplainData, 8);
	return analysis.getResults();
}

function sortJsonArrayDesc(arr, key){
	arr.sort(function(a,b){
		return b[key] - a[key];
	});
	return arr;	
}

function sortJsonArrayAsc(arr, key){
	arr.sort(function(a,b){
		return a[key] - b[key];
	});
	return arr;	
}

Array.prototype.unique = function() {
  return this.filter(function (value, index, self) { 
    return self.indexOf(value) === index;
  });
}


function buildBoostGraph(obj, title, total) {
	var percent = 100*(parseFloat(obj.contributedScore)/parseFloat(total)).toFixed(2);

	sQstr = '<div class="score-wrapper">';
	sQstr += '<div class="score-term">' + title + '</div>';
	sQstr += '<div class="score-field">Score = ' + obj.contributedScore + ' - <span class="score-percent">' + percent + '%</span></div>';	
	sQstr += '<div style="width:' + percent + '%;" class="score-bar"></div>';	
	sQstr += '<div class="score-field font80">' + obj.formula + '</div>';	
	sQstr += '</div>';	
	return sQstr;
}


function buildScoreGraph(arr, title) {
	sortJsonArrayDesc(arr, "percentOfTotal");
	sQstr = '<div class="score-wrapper">';
	sQstr += '<div class="score-term">' + title + '</div>';
	for(var i=0; i<arr.length; i++){
		if( parseFloat(arr[i].percentOfTotal ) == 0.00) continue;
		var term = field = '';
		if( arr[i].field !== undefined ) { field = arr[i].field; }
		if( arr[i].term !== undefined ) { 
			if( field !== '' ){ term = ' : '; }
			term += arr[i].term; 
		}
		sQstr += '<div class="score-field" title="Score=' + arr[i].naturalScore + '">' + field + term + ' - <span class="score-percent">' + parseFloat(arr[i].percentOfTotal).toFixed(2) + '%</span></div>';	
		sQstr += '<div style="width:' + arr[i].percentOfTotal + '%;" class="score-bar"></div>';			
	}
	sQstr += '</div>';	
	return sQstr;
}